{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"C:\\\\PoC\\\\restaurant_sidechain\\\\web\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/regenerator\");\n\nvar _asyncToGenerator = require(\"C:\\\\PoC\\\\restaurant_sidechain\\\\web\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/asyncToGenerator\");\n\nvar _classCallCheck = require(\"C:\\\\PoC\\\\restaurant_sidechain\\\\web\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"C:\\\\PoC\\\\restaurant_sidechain\\\\web\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/createClass\");\n\nvar _inherits = require(\"C:\\\\PoC\\\\restaurant_sidechain\\\\web\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/inherits\");\n\nvar _createSuper = require(\"C:\\\\PoC\\\\restaurant_sidechain\\\\web\\\\node_modules\\\\babel-preset-react-app\\\\node_modules\\\\@babel\\\\runtime/helpers/createSuper\");\n\nvar __rest = this && this.__rest || function (s, e) {\n  var t = {};\n\n  for (var p in s) {\n    if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  }\n\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar base_transaction_1 = require(\"./base_transaction\");\n\nvar constants_1 = require(\"./constants\");\n\nvar errors_1 = require(\"./errors\");\n\nvar utils_1 = require(\"./utils\");\n\nexports.delegateAssetFormatSchema = {\n  type: 'object',\n  required: ['delegate'],\n  properties: {\n    delegate: {\n      type: 'object',\n      required: ['username'],\n      properties: {\n        username: {\n          type: 'string',\n          minLength: 1,\n          maxLength: 20,\n          format: 'username'\n        }\n      }\n    }\n  }\n};\n\nvar DelegateTransaction = /*#__PURE__*/function (_base_transaction_1$B) {\n  _inherits(DelegateTransaction, _base_transaction_1$B);\n\n  var _super = _createSuper(DelegateTransaction);\n\n  function DelegateTransaction(rawTransaction) {\n    var _this;\n\n    _classCallCheck(this, DelegateTransaction);\n\n    _this = _super.call(this, rawTransaction);\n    var tx = typeof rawTransaction === 'object' && rawTransaction !== null ? rawTransaction : {};\n    _this.asset = tx.asset || {\n      delegate: {}\n    };\n    _this.containsUniqueData = true;\n    return _this;\n  }\n\n  _createClass(DelegateTransaction, [{\n    key: \"assetToBytes\",\n    value: function assetToBytes() {\n      var username = this.asset.delegate.username;\n      return Buffer.from(username, 'utf8');\n    }\n  }, {\n    key: \"prepare\",\n    value: function () {\n      var _prepare = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(store) {\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return store.account.cache([{\n                  address: this.senderId\n                }, {\n                  username: this.asset.delegate.username\n                }]);\n\n              case 2:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function prepare(_x) {\n        return _prepare.apply(this, arguments);\n      }\n\n      return prepare;\n    }()\n  }, {\n    key: \"verifyAgainstTransactions\",\n    value: function verifyAgainstTransactions(transactions) {\n      var _this2 = this;\n\n      return transactions.filter(function (tx) {\n        return tx.type === _this2.type && tx.senderPublicKey === _this2.senderPublicKey;\n      }).map(function (tx) {\n        return new errors_1.TransactionError('Register delegate only allowed once per account.', tx.id, '.asset.delegate');\n      });\n    }\n  }, {\n    key: \"validateAsset\",\n    value: function validateAsset() {\n      utils_1.validator.validate(exports.delegateAssetFormatSchema, this.asset);\n      var errors = errors_1.convertToAssetError(this.id, utils_1.validator.errors);\n\n      if (!this.amount.eq(0)) {\n        errors.push(new errors_1.TransactionError('Amount must be zero for delegate registration transaction', this.id, '.amount', this.amount.toString(), '0'));\n      }\n\n      if (this.recipientId) {\n        errors.push(new errors_1.TransactionError('RecipientId is expected to be undefined', this.id, '.recipientId', this.recipientId));\n      }\n\n      if (this.recipientPublicKey) {\n        errors.push(new errors_1.TransactionError('Invalid recipientPublicKey', this.id, '.recipientPublicKey'));\n      }\n\n      return errors;\n    }\n  }, {\n    key: \"applyAsset\",\n    value: function applyAsset(store) {\n      var _this3 = this;\n\n      var errors = [];\n      var sender = store.account.get(this.senderId);\n      var usernameExists = store.account.find(function (account) {\n        return account.username === _this3.asset.delegate.username;\n      });\n\n      if (usernameExists) {\n        errors.push(new errors_1.TransactionError(\"Username is not unique.\", this.id, '.asset.delegate.username'));\n      }\n\n      if (sender.isDelegate || sender.username) {\n        errors.push(new errors_1.TransactionError('Account is already a delegate', this.id, '.asset.delegate.username'));\n      }\n\n      var updatedSender = Object.assign({}, sender, {\n        username: this.asset.delegate.username,\n        vote: 0,\n        isDelegate: 1\n      });\n      store.account.set(updatedSender.address, updatedSender);\n      return errors;\n    }\n  }, {\n    key: \"undoAsset\",\n    value: function undoAsset(store) {\n      var sender = store.account.get(this.senderId);\n\n      var username = sender.username,\n          strippedSender = __rest(sender, [\"username\"]);\n\n      var resetSender = Object.assign({}, sender, {\n        username: null,\n        vote: 0,\n        isDelegate: 0\n      });\n      store.account.set(strippedSender.address, resetSender);\n      return [];\n    }\n  }, {\n    key: \"assetFromSync\",\n    value: function assetFromSync(raw) {\n      if (!raw.d_username) {\n        return undefined;\n      }\n\n      var delegate = {\n        username: raw.d_username,\n        publicKey: raw.t_senderPublicKey,\n        address: raw.t_senderId\n      };\n      return {\n        delegate: delegate\n      };\n    }\n  }]);\n\n  return DelegateTransaction;\n}(base_transaction_1.BaseTransaction);\n\nDelegateTransaction.TYPE = 2;\nDelegateTransaction.FEE = constants_1.DELEGATE_FEE.toString();\nexports.DelegateTransaction = DelegateTransaction;","map":{"version":3,"sources":["../src/2_delegate_transaction.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\r\nvar __rest = (this && this.__rest) || function (s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)\r\n            t[p[i]] = s[p[i]];\r\n    return t;\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nconst base_transaction_1 = require(\"./base_transaction\");\r\nconst constants_1 = require(\"./constants\");\r\nconst errors_1 = require(\"./errors\");\r\nconst utils_1 = require(\"./utils\");\r\nexports.delegateAssetFormatSchema = {\r\n    type: 'object',\r\n    required: ['delegate'],\r\n    properties: {\r\n        delegate: {\r\n            type: 'object',\r\n            required: ['username'],\r\n            properties: {\r\n                username: {\r\n                    type: 'string',\r\n                    minLength: 1,\r\n                    maxLength: 20,\r\n                    format: 'username',\r\n                },\r\n            },\r\n        },\r\n    },\r\n};\r\nclass DelegateTransaction extends base_transaction_1.BaseTransaction {\r\n    constructor(rawTransaction) {\r\n        super(rawTransaction);\r\n        const tx = (typeof rawTransaction === 'object' && rawTransaction !== null\r\n            ? rawTransaction\r\n            : {});\r\n        this.asset = (tx.asset || { delegate: {} });\r\n        this.containsUniqueData = true;\r\n    }\r\n    assetToBytes() {\r\n        const { delegate: { username }, } = this.asset;\r\n        return Buffer.from(username, 'utf8');\r\n    }\r\n    async prepare(store) {\r\n        await store.account.cache([\r\n            {\r\n                address: this.senderId,\r\n            },\r\n            {\r\n                username: this.asset.delegate.username,\r\n            },\r\n        ]);\r\n    }\r\n    verifyAgainstTransactions(transactions) {\r\n        return transactions\r\n            .filter(tx => tx.type === this.type && tx.senderPublicKey === this.senderPublicKey)\r\n            .map(tx => new errors_1.TransactionError('Register delegate only allowed once per account.', tx.id, '.asset.delegate'));\r\n    }\r\n    validateAsset() {\r\n        utils_1.validator.validate(exports.delegateAssetFormatSchema, this.asset);\r\n        const errors = errors_1.convertToAssetError(this.id, utils_1.validator.errors);\r\n        if (!this.amount.eq(0)) {\r\n            errors.push(new errors_1.TransactionError('Amount must be zero for delegate registration transaction', this.id, '.amount', this.amount.toString(), '0'));\r\n        }\r\n        if (this.recipientId) {\r\n            errors.push(new errors_1.TransactionError('RecipientId is expected to be undefined', this.id, '.recipientId', this.recipientId));\r\n        }\r\n        if (this.recipientPublicKey) {\r\n            errors.push(new errors_1.TransactionError('Invalid recipientPublicKey', this.id, '.recipientPublicKey'));\r\n        }\r\n        return errors;\r\n    }\r\n    applyAsset(store) {\r\n        const errors = [];\r\n        const sender = store.account.get(this.senderId);\r\n        const usernameExists = store.account.find((account) => account.username === this.asset.delegate.username);\r\n        if (usernameExists) {\r\n            errors.push(new errors_1.TransactionError(`Username is not unique.`, this.id, '.asset.delegate.username'));\r\n        }\r\n        if (sender.isDelegate || sender.username) {\r\n            errors.push(new errors_1.TransactionError('Account is already a delegate', this.id, '.asset.delegate.username'));\r\n        }\r\n        const updatedSender = Object.assign({}, sender, { username: this.asset.delegate.username, vote: 0, isDelegate: 1 });\r\n        store.account.set(updatedSender.address, updatedSender);\r\n        return errors;\r\n    }\r\n    undoAsset(store) {\r\n        const sender = store.account.get(this.senderId);\r\n        const { username } = sender, strippedSender = __rest(sender, [\"username\"]);\r\n        const resetSender = Object.assign({}, sender, { username: null, vote: 0, isDelegate: 0 });\r\n        store.account.set(strippedSender.address, resetSender);\r\n        return [];\r\n    }\r\n    assetFromSync(raw) {\r\n        if (!raw.d_username) {\r\n            return undefined;\r\n        }\r\n        const delegate = {\r\n            username: raw.d_username,\r\n            publicKey: raw.t_senderPublicKey,\r\n            address: raw.t_senderId,\r\n        };\r\n        return { delegate };\r\n    }\r\n}\r\nDelegateTransaction.TYPE = 2;\r\nDelegateTransaction.FEE = constants_1.DELEGATE_FEE.toString();\r\nexports.DelegateTransaction = DelegateTransaction;\r\n//# sourceMappingURL=2_delegate_transaction.js.map"]},"metadata":{},"sourceType":"script"}