{"ast":null,"code":"const {\n  BaseTransaction,\n  TransactionError,\n  utils\n} = require('@liskhq/lisk-transactions');\n\nclass FoodTransaction extends BaseTransaction {\n  get sidechainAccountId() {\n    return \"6181773985994883123L\";\n  }\n\n  get sidechainFee() {\n    return '50000000';\n  }\n\n  static get TYPE() {\n    return 820;\n  }\n\n  static get FEE() {\n    return `10000000`;\n  }\n\n  /* Prepare function stores both sender and recipient account in the cache so it is possible to\r\n     modify the accounts during the `applyAsset` and `undoAsset` steps. */\n  async prepare(store) {\n    await store.account.cache([{\n      address: this.asset.recipientId\n    }, {\n      address: this.senderId\n    }, {\n      address: this.sidechainAccountId\n    }]);\n  }\n\n  validateAsset() {\n    const errors = [];\n    /*\r\n            if(!utils.validateAddress(this.senderId)){\r\n                errors.push(new TransactionError(\r\n                    'Invalid client \"Lisk address\" defined on transaction',\r\n                    this.id,\r\n                    \"client lisk address\",\r\n                    this.senderId\r\n                ));\r\n            }\r\n    \r\n            if (!utils.validatePublicKey(this.senderPublicKey)){\r\n                errors.push(new TransactionError(\r\n                    'Invalid client \"Lisk public key\" defined on transaction',\r\n                    this.id,\r\n                    \"client public key\",\r\n                    this.senderPublicKey\r\n                ));\r\n            }                               \r\n    */\n\n    if (!this.asset.description || typeof this.asset.description !== 'string' || this.asset.name.length > 1500) {\n      errors.push(new TransactionError('Invalid \"description\" defined on transaction', this.id, '.asset.description', this.asset.name, 'A string value no longer than 1500 characters'));\n    }\n\n    if (!this.asset.foodType || this.asset.foodType <= 0) {\n      errors.push(new TransactionError('Invalid \"food type\" defined on transaction', this.id, '.foodType', this.asset.foodType, 'A value bigger than 0'));\n    }\n\n    if (!this.asset.deliveryaddress) {\n      errors.push(new TransactionError('Invalid \"delivery address\" defined on transaction', this.id, '.deliveryaddress', this.asset.deliveryaddress, 'A string value bigger than 0'));\n    }\n\n    if (!this.asset.phone) {\n      errors.push(new TransactionError('Invalid \"phone\" defined on transaction', this.id, '.phone', this.asset.phone, 'A value bigger than 0'));\n    }\n\n    if (!this.asset.username) {\n      errors.push(new TransactionError('Invalid \"username\" defined on transaction', this.id, '.username', this.asset.username, 'A string value bigger than 0'));\n    }\n\n    if (!this.asset.amount || this.asset.amount <= 0) {\n      errors.push(new TransactionError('Invalid \"value\" defined on transaction', this.id, '.asset.amount', this.asset.amount, 'A value bigger than 0'));\n    }\n\n    if (!this.asset.clientData || this.asset.clientData.length === 0) {\n      errors.push(new TransactionError('Invalid \"clientData\" defined on transaction', this.id, '.clientData', this.asset.clientData, 'Not empty'));\n    }\n\n    if (!this.asset.clientNonce || this.asset.clientNonce.length === 0) {\n      errors.push(new TransactionError('Invalid \"clientNonce\" defined on transaction', this.id, '.clientNonce', this.asset.clientNonce, 'Not empty'));\n    }\n\n    return errors;\n  }\n\n  applyAsset(store) {\n    const errors = [];\n    const sender = store.account.get(this.senderId);\n\n    if (!sender) {\n      errors.push(new TransactionError('Invalid \"sender\", please verify your passphrase', this.id, '.sender', this.senderId, 'Verify your passpahrase and address'));\n    }\n\n    const senderBalanceDeducted = new utils.BigNum(sender.balance).sub(new utils.BigNum(this.asset.amount));\n\n    if (senderBalanceDeducted < 0) {\n      errors.push(new TransactionError('Not enough \"balance\" for the transaction', this.id, '.asset.amount', this.asset.amount, 'Need a balance at least equal than amount'));\n    }\n\n    const updatedSender = { ...sender,\n      balance: senderBalanceDeducted.toString()\n    };\n    store.account.set(sender.address, updatedSender);\n    const restaurantAccount = store.account.get(this.asset.recipientId);\n    const restaurantBalanceWithFoodRequest = new utils.BigNum(restaurantAccount.balance).add(new utils.BigNum(this.asset.amount)).sub(new utils.BigNum(this.sidechainFee));\n    const updatedRestaurantAccount = { ...restaurantAccount,\n      ...{\n        balance: restaurantBalanceWithFoodRequest.toString(),\n        asset: {\n          name: this.asset.name,\n          description: this.asset.description,\n          foodType: this.asset.foodType,\n          username: this.asset.username,\n          phone: this.asset.phone,\n          deliveryaddress: this.asset.deliveryaddress,\n          observation: this.asset.observation,\n          clientData: this.asset.clientData,\n          clientNonce: this.asset.clientNonce,\n          recipientId: this.asset.recipientId,\n          amount: this.asset.amount\n        }\n      }\n    };\n    store.account.set(restaurantAccount.address, updatedRestaurantAccount);\n    /*\r\n    const sidechainAcc = store.account.get(this.sidechainAccountId);\r\n    const sidechainBalanceWithFee = new utils.BigNum(sidechainAcc.balance).add(new utils.BigNum(this.sidechainFee));\r\n    const updatedSidechainAccount = {\r\n        ...sidechainAcc,\r\n        balance: sidechainBalanceWithFee.toString(),\r\n        asset: {\r\n            message: \"fee\"\r\n        }\r\n    };\r\n      store.account.set(sidechainAcc.address, updatedSidechainAccount);\r\n            */\n\n    return errors;\n  }\n  /* UndoAsset function tells the blockchain how to rollback changes made in the applyAsset function.\r\n      The original balance for both the sender and restaurant account is restored.\r\n      In addition, the `asset` field for the restaurant account `null` is reseted, as it did not hold any previous data.*/\n\n  /* --- Revert sender account --- */\n\n\n  undoAsset(store) {\n    const sender = store.account.get(this.senderId);\n    const senderBalanceWithFoodAmount = new utils.BigNum(sender.balance).add(new utils.BigNum(this.asset.amount));\n    const updatedSender = { ...sender,\n      balance: senderBalanceWithFoodAmount.toString()\n    };\n    store.account.set(sender.address, updatedSender);\n    const restaurantAccount = store.account.get(this.asset.recipientId);\n    const restaurantBalanceWithFoodRequest = new utils.BigNum(restaurantAccount.balance).sub(new utils.BigNum(this.asset.amount).add(new utils.BigNum(this.sidechainFee)));\n    const updatedRestaurantAccount = { ...sender,\n      ...{\n        balance: restaurantBalanceWithFoodRequest.toString(),\n        asset: null\n      }\n    };\n    store.account.set(restaurantAccount.address, updatedRestaurantAccount);\n    /*\r\n            const sidechainAcc = store.account.get(this.sidechainAccount);\r\n            const sidechainBalanceWithoutFee = new utils.BigNum(sidechainAcc.balance).sub(new utils.BigNum(this.sidechainFee));\r\n    \r\n            const updatedSidechainAccount = {\r\n                ...sidechainAcc,\r\n                balance: sidechainBalanceWithoutFee.toString()\r\n            };\r\n    \r\n            store.account.set(sidechainAcc.address, updatedSidechainAccount);\r\n    */\n\n    return [];\n  }\n\n}\n\nmodule.exports = FoodTransaction;","map":{"version":3,"sources":["C:/PoC/restaurant_sidechain/web/node_modules/liskrestaurant_transactions/FoodTransaction.js"],"names":["BaseTransaction","TransactionError","utils","require","FoodTransaction","sidechainAccountId","sidechainFee","TYPE","FEE","prepare","store","account","cache","address","asset","recipientId","senderId","validateAsset","errors","description","name","length","push","id","foodType","deliveryaddress","phone","username","amount","clientData","clientNonce","applyAsset","sender","get","senderBalanceDeducted","BigNum","balance","sub","updatedSender","toString","set","restaurantAccount","restaurantBalanceWithFoodRequest","add","updatedRestaurantAccount","observation","undoAsset","senderBalanceWithFoodAmount","module","exports"],"mappings":"AAAA,MAAM;AACFA,EAAAA,eADE;AAEFC,EAAAA,gBAFE;AAGFC,EAAAA;AAHE,IAIFC,OAAO,CAAC,2BAAD,CAJX;;AAMA,MAAMC,eAAN,SAA8BJ,eAA9B,CAA8C;AAE1C,MAAIK,kBAAJ,GAA0B;AACtB,WAAO,sBAAP;AACH;;AAED,MAAIC,YAAJ,GAAoB;AAChB,WAAO,UAAP;AACH;;AAED,aAAWC,IAAX,GAAkB;AACd,WAAO,GAAP;AACH;;AAED,aAAWC,GAAX,GAAkB;AACpB,WAAQ,UAAR;AACG;;AAED;;AAEA,QAAMC,OAAN,CAAcC,KAAd,EAAqB;AACjB,UAAMA,KAAK,CAACC,OAAN,CAAcC,KAAd,CAAoB,CACtB;AACIC,MAAAA,OAAO,EAAE,KAAKC,KAAL,CAAWC;AADxB,KADsB,EAItB;AACIF,MAAAA,OAAO,EAAE,KAAKG;AADlB,KAJsB,EAOtB;AACIH,MAAAA,OAAO,EAAE,KAAKR;AADlB,KAPsB,CAApB,CAAN;AAWH;;AAEDY,EAAAA,aAAa,GAAE;AACX,UAAMC,MAAM,GAAG,EAAf;AACR;;;;;;;;;;;;;;;;;;;;AAmBQ,QAAI,CAAC,KAAKJ,KAAL,CAAWK,WAAZ,IAA2B,OAAO,KAAKL,KAAL,CAAWK,WAAlB,KAAkC,QAA7D,IAAyE,KAAKL,KAAL,CAAWM,IAAX,CAAgBC,MAAhB,GAAyB,IAAtG,EAA2G;AACvGH,MAAAA,MAAM,CAACI,IAAP,CACI,IAAIrB,gBAAJ,CACI,8CADJ,EAEI,KAAKsB,EAFT,EAGI,oBAHJ,EAII,KAAKT,KAAL,CAAWM,IAJf,EAKI,+CALJ,CADJ;AASH;;AAED,QAAI,CAAC,KAAKN,KAAL,CAAWU,QAAZ,IAAwB,KAAKV,KAAL,CAAWU,QAAX,IAAuB,CAAnD,EAAqD;AACjDN,MAAAA,MAAM,CAACI,IAAP,CACI,IAAIrB,gBAAJ,CACI,4CADJ,EAEI,KAAKsB,EAFT,EAGI,WAHJ,EAII,KAAKT,KAAL,CAAWU,QAJf,EAKI,uBALJ,CADJ;AASH;;AAED,QAAI,CAAC,KAAKV,KAAL,CAAWW,eAAhB,EAAgC;AAC5BP,MAAAA,MAAM,CAACI,IAAP,CACI,IAAIrB,gBAAJ,CACI,mDADJ,EAEI,KAAKsB,EAFT,EAGI,kBAHJ,EAII,KAAKT,KAAL,CAAWW,eAJf,EAKI,8BALJ,CADJ;AASH;;AAED,QAAI,CAAC,KAAKX,KAAL,CAAWY,KAAhB,EAAsB;AAClBR,MAAAA,MAAM,CAACI,IAAP,CACI,IAAIrB,gBAAJ,CACI,wCADJ,EAEI,KAAKsB,EAFT,EAGI,QAHJ,EAII,KAAKT,KAAL,CAAWY,KAJf,EAKI,uBALJ,CADJ;AASH;;AAED,QAAI,CAAC,KAAKZ,KAAL,CAAWa,QAAhB,EAAyB;AACrBT,MAAAA,MAAM,CAACI,IAAP,CACI,IAAIrB,gBAAJ,CACI,2CADJ,EAEI,KAAKsB,EAFT,EAGI,WAHJ,EAII,KAAKT,KAAL,CAAWa,QAJf,EAKI,8BALJ,CADJ;AASH;;AAED,QAAI,CAAC,KAAKb,KAAL,CAAWc,MAAZ,IAAsB,KAAKd,KAAL,CAAWc,MAAX,IAAqB,CAA/C,EAAiD;AAC7CV,MAAAA,MAAM,CAACI,IAAP,CACI,IAAIrB,gBAAJ,CACI,wCADJ,EAEI,KAAKsB,EAFT,EAGI,eAHJ,EAII,KAAKT,KAAL,CAAWc,MAJf,EAKI,uBALJ,CADJ;AASH;;AAED,QAAI,CAAC,KAAKd,KAAL,CAAWe,UAAZ,IAA0B,KAAKf,KAAL,CAAWe,UAAX,CAAsBR,MAAtB,KAAiC,CAA/D,EAAiE;AAC7DH,MAAAA,MAAM,CAACI,IAAP,CACI,IAAIrB,gBAAJ,CACI,6CADJ,EAEI,KAAKsB,EAFT,EAGI,aAHJ,EAII,KAAKT,KAAL,CAAWe,UAJf,EAKI,WALJ,CADJ;AASH;;AAED,QAAI,CAAC,KAAKf,KAAL,CAAWgB,WAAZ,IAA2B,KAAKhB,KAAL,CAAWgB,WAAX,CAAuBT,MAAvB,KAAkC,CAAjE,EAAmE;AAC/DH,MAAAA,MAAM,CAACI,IAAP,CACI,IAAIrB,gBAAJ,CACI,8CADJ,EAEI,KAAKsB,EAFT,EAGI,cAHJ,EAII,KAAKT,KAAL,CAAWgB,WAJf,EAKI,WALJ,CADJ;AASH;;AAED,WAAOZ,MAAP;AACH;;AAEDa,EAAAA,UAAU,CAACrB,KAAD,EAAO;AACb,UAAMQ,MAAM,GAAG,EAAf;AAEA,UAAMc,MAAM,GAAGtB,KAAK,CAACC,OAAN,CAAcsB,GAAd,CAAkB,KAAKjB,QAAvB,CAAf;;AAEA,QAAI,CAACgB,MAAL,EAAY;AACRd,MAAAA,MAAM,CAACI,IAAP,CACI,IAAIrB,gBAAJ,CACI,iDADJ,EAEI,KAAKsB,EAFT,EAGI,SAHJ,EAII,KAAKP,QAJT,EAKI,qCALJ,CADJ;AASH;;AAED,UAAMkB,qBAAqB,GAAG,IAAIhC,KAAK,CAACiC,MAAV,CAAiBH,MAAM,CAACI,OAAxB,EAAiCC,GAAjC,CAAqC,IAAInC,KAAK,CAACiC,MAAV,CAAiB,KAAKrB,KAAL,CAAWc,MAA5B,CAArC,CAA9B;;AAEA,QAAIM,qBAAqB,GAAG,CAA5B,EAA8B;AAC1BhB,MAAAA,MAAM,CAACI,IAAP,CACI,IAAIrB,gBAAJ,CACI,0CADJ,EAEI,KAAKsB,EAFT,EAGI,eAHJ,EAII,KAAKT,KAAL,CAAWc,MAJf,EAKI,2CALJ,CADJ;AASH;;AAED,UAAMU,aAAa,GAAG,EAClB,GAAGN,MADe;AAElBI,MAAAA,OAAO,EAAEF,qBAAqB,CAACK,QAAtB;AAFS,KAAtB;AAIA7B,IAAAA,KAAK,CAACC,OAAN,CAAc6B,GAAd,CAAkBR,MAAM,CAACnB,OAAzB,EAAkCyB,aAAlC;AAEA,UAAMG,iBAAiB,GAAG/B,KAAK,CAACC,OAAN,CAAcsB,GAAd,CAAkB,KAAKnB,KAAL,CAAWC,WAA7B,CAA1B;AACA,UAAM2B,gCAAgC,GAAG,IAAIxC,KAAK,CAACiC,MAAV,CAAiBM,iBAAiB,CAACL,OAAnC,EAA4CO,GAA5C,CAAgD,IAAIzC,KAAK,CAACiC,MAAV,CAAiB,KAAKrB,KAAL,CAAWc,MAA5B,CAAhD,EAAqFS,GAArF,CAAyF,IAAInC,KAAK,CAACiC,MAAV,CAAiB,KAAK7B,YAAtB,CAAzF,CAAzC;AAEA,UAAMsC,wBAAwB,GAAG,EAAC,GAAGH,iBAAJ;AAC7B,SAAG;AACCL,QAAAA,OAAO,EAAEM,gCAAgC,CAACH,QAAjC,EADV;AAECzB,QAAAA,KAAK,EAAE;AACHM,UAAAA,IAAI,EAAE,KAAKN,KAAL,CAAWM,IADd;AAEHD,UAAAA,WAAW,EAAE,KAAKL,KAAL,CAAWK,WAFrB;AAGHK,UAAAA,QAAQ,EAAE,KAAKV,KAAL,CAAWU,QAHlB;AAIHG,UAAAA,QAAQ,EAAE,KAAKb,KAAL,CAAWa,QAJlB;AAKHD,UAAAA,KAAK,EAAE,KAAKZ,KAAL,CAAWY,KALf;AAMHD,UAAAA,eAAe,EAAE,KAAKX,KAAL,CAAWW,eANzB;AAOHoB,UAAAA,WAAW,EAAE,KAAK/B,KAAL,CAAW+B,WAPrB;AAQHhB,UAAAA,UAAU,EAAE,KAAKf,KAAL,CAAWe,UARpB;AASHC,UAAAA,WAAW,EAAE,KAAKhB,KAAL,CAAWgB,WATrB;AAUHf,UAAAA,WAAW,EAAE,KAAKD,KAAL,CAAWC,WAVrB;AAWHa,UAAAA,MAAM,EAAE,KAAKd,KAAL,CAAWc;AAXhB;AAFR;AAD0B,KAAjC;AAmBAlB,IAAAA,KAAK,CAACC,OAAN,CAAc6B,GAAd,CAAkBC,iBAAiB,CAAC5B,OAApC,EAA6C+B,wBAA7C;AACA;;;;;;;;;;;;;AAaA,WAAO1B,MAAP;AACH;AAED;;;;AAGA;;;AACA4B,EAAAA,SAAS,CAACpC,KAAD,EAAO;AACZ,UAAMsB,MAAM,GAAGtB,KAAK,CAACC,OAAN,CAAcsB,GAAd,CAAkB,KAAKjB,QAAvB,CAAf;AAEA,UAAM+B,2BAA2B,GAAG,IAAI7C,KAAK,CAACiC,MAAV,CAAiBH,MAAM,CAACI,OAAxB,EAAiCO,GAAjC,CAAqC,IAAIzC,KAAK,CAACiC,MAAV,CAAiB,KAAKrB,KAAL,CAAWc,MAA5B,CAArC,CAApC;AACA,UAAMU,aAAa,GAAG,EAClB,GAAGN,MADe;AAElBI,MAAAA,OAAO,EAAEW,2BAA2B,CAACR,QAA5B;AAFS,KAAtB;AAIA7B,IAAAA,KAAK,CAACC,OAAN,CAAc6B,GAAd,CAAkBR,MAAM,CAACnB,OAAzB,EAAkCyB,aAAlC;AAEA,UAAMG,iBAAiB,GAAG/B,KAAK,CAACC,OAAN,CAAcsB,GAAd,CAAkB,KAAKnB,KAAL,CAAWC,WAA7B,CAA1B;AACA,UAAM2B,gCAAgC,GAAG,IAAIxC,KAAK,CAACiC,MAAV,CAAiBM,iBAAiB,CAACL,OAAnC,EAA4CC,GAA5C,CAAgD,IAAInC,KAAK,CAACiC,MAAV,CAAiB,KAAKrB,KAAL,CAAWc,MAA5B,EAAoCe,GAApC,CAAwC,IAAIzC,KAAK,CAACiC,MAAV,CAAiB,KAAK7B,YAAtB,CAAxC,CAAhD,CAAzC;AAEA,UAAMsC,wBAAwB,GAAG,EAAC,GAAGZ,MAAJ;AAC7B,SAAI;AAAEI,QAAAA,OAAO,EAAEM,gCAAgC,CAACH,QAAjC,EAAX;AACJzB,QAAAA,KAAK,EAAE;AADH;AADyB,KAAjC;AAIAJ,IAAAA,KAAK,CAACC,OAAN,CAAc6B,GAAd,CAAkBC,iBAAiB,CAAC5B,OAApC,EAA6C+B,wBAA7C;AACR;;;;;;;;;;;;AAWQ,WAAO,EAAP;AACH;;AAxQyC;;AA2Q9CI,MAAM,CAACC,OAAP,GAAiB7C,eAAjB","sourcesContent":["const {\r\n    BaseTransaction,\r\n    TransactionError, \r\n    utils\r\n} = require('@liskhq/lisk-transactions');\r\n\r\nclass FoodTransaction extends BaseTransaction {\r\n\r\n    get sidechainAccountId () {\r\n        return \"6181773985994883123L\";\r\n    }\r\n\r\n    get sidechainFee () {\r\n        return '50000000';\r\n    }\r\n\r\n    static get TYPE() {\r\n        return 820;\r\n    }\r\n\r\n    static get FEE () {\r\n\t\treturn `10000000`;\r\n    };        \r\n\r\n    /* Prepare function stores both sender and recipient account in the cache so it is possible to\r\n       modify the accounts during the `applyAsset` and `undoAsset` steps. */\r\n    async prepare(store) {\r\n        await store.account.cache([\r\n            {\r\n                address: this.asset.recipientId,\r\n            },\r\n            {\r\n                address: this.senderId,\r\n            },\r\n            {\r\n                address: this.sidechainAccountId\r\n            }\r\n        ]);\r\n    }\r\n\r\n    validateAsset(){\r\n        const errors = [];        \r\n/*\r\n        if(!utils.validateAddress(this.senderId)){\r\n            errors.push(new TransactionError(\r\n                'Invalid client \"Lisk address\" defined on transaction',\r\n                this.id,\r\n                \"client lisk address\",\r\n                this.senderId\r\n            ));\r\n        }\r\n\r\n        if (!utils.validatePublicKey(this.senderPublicKey)){\r\n            errors.push(new TransactionError(\r\n                'Invalid client \"Lisk public key\" defined on transaction',\r\n                this.id,\r\n                \"client public key\",\r\n                this.senderPublicKey\r\n            ));\r\n        }                               \r\n*/\r\n        if (!this.asset.description || typeof this.asset.description !== 'string' || this.asset.name.length > 1500){\r\n            errors.push(\r\n                new TransactionError(\r\n                    'Invalid \"description\" defined on transaction',\r\n                    this.id,\r\n                    '.asset.description',\r\n                    this.asset.name,\r\n                    'A string value no longer than 1500 characters'\r\n                )\r\n            );\r\n        }\r\n\r\n        if (!this.asset.foodType || this.asset.foodType <= 0){\r\n            errors.push(\r\n                new TransactionError(\r\n                    'Invalid \"food type\" defined on transaction',\r\n                    this.id,\r\n                    '.foodType',\r\n                    this.asset.foodType,\r\n                    'A value bigger than 0'\r\n                )\r\n            );\r\n        }\r\n\r\n        if (!this.asset.deliveryaddress){\r\n            errors.push(\r\n                new TransactionError(\r\n                    'Invalid \"delivery address\" defined on transaction',\r\n                    this.id,\r\n                    '.deliveryaddress',\r\n                    this.asset.deliveryaddress,\r\n                    'A string value bigger than 0'\r\n                )\r\n            );\r\n        }\r\n\r\n        if (!this.asset.phone){\r\n            errors.push(\r\n                new TransactionError(\r\n                    'Invalid \"phone\" defined on transaction',\r\n                    this.id,\r\n                    '.phone',\r\n                    this.asset.phone,\r\n                    'A value bigger than 0'\r\n                )\r\n            );\r\n        }\r\n\r\n        if (!this.asset.username){\r\n            errors.push(\r\n                new TransactionError(\r\n                    'Invalid \"username\" defined on transaction',\r\n                    this.id,\r\n                    '.username',\r\n                    this.asset.username,\r\n                    'A string value bigger than 0'\r\n                )\r\n            );\r\n        }\r\n        \r\n        if (!this.asset.amount || this.asset.amount <= 0){\r\n            errors.push(\r\n                new TransactionError(\r\n                    'Invalid \"value\" defined on transaction',\r\n                    this.id,\r\n                    '.asset.amount',\r\n                    this.asset.amount,\r\n                    'A value bigger than 0'\r\n                )\r\n            );\r\n        }\r\n\r\n        if (!this.asset.clientData || this.asset.clientData.length === 0){\r\n            errors.push(\r\n                new TransactionError(\r\n                    'Invalid \"clientData\" defined on transaction',\r\n                    this.id,\r\n                    '.clientData',\r\n                    this.asset.clientData,\r\n                    'Not empty'\r\n                )\r\n            );\r\n        }\r\n\r\n        if (!this.asset.clientNonce || this.asset.clientNonce.length === 0){\r\n            errors.push(\r\n                new TransactionError(\r\n                    'Invalid \"clientNonce\" defined on transaction',\r\n                    this.id,\r\n                    '.clientNonce',\r\n                    this.asset.clientNonce,\r\n                    'Not empty'\r\n                )\r\n            );\r\n        }\r\n\r\n        return errors;\r\n    }\r\n\r\n    applyAsset(store){               \r\n        const errors = [];\r\n        \r\n        const sender = store.account.get(this.senderId);\r\n\r\n        if (!sender){           \r\n            errors.push(\r\n                new TransactionError(\r\n                    'Invalid \"sender\", please verify your passphrase',\r\n                    this.id,\r\n                    '.sender',\r\n                    this.senderId,\r\n                    'Verify your passpahrase and address'\r\n                )\r\n            );            \r\n        }\r\n\r\n        const senderBalanceDeducted = new utils.BigNum(sender.balance).sub(new utils.BigNum(this.asset.amount));            \r\n\r\n        if (senderBalanceDeducted < 0){\r\n            errors.push(\r\n                new TransactionError(\r\n                    'Not enough \"balance\" for the transaction',\r\n                    this.id,\r\n                    '.asset.amount',\r\n                    this.asset.amount,\r\n                    'Need a balance at least equal than amount'\r\n                )\r\n            );\r\n        }\r\n\r\n        const updatedSender = {\r\n            ...sender,\r\n            balance: senderBalanceDeducted.toString()\r\n        }\r\n        store.account.set(sender.address, updatedSender);\r\n\r\n        const restaurantAccount = store.account.get(this.asset.recipientId);\r\n        const restaurantBalanceWithFoodRequest = new utils.BigNum(restaurantAccount.balance).add(new utils.BigNum(this.asset.amount)).sub(new utils.BigNum(this.sidechainFee)); \r\n        \r\n        const updatedRestaurantAccount = {...restaurantAccount, \r\n            ...{ \r\n                balance: restaurantBalanceWithFoodRequest.toString(),\r\n                asset: { \r\n                    name: this.asset.name, \r\n                    description: this.asset.description, \r\n                    foodType: this.asset.foodType, \r\n                    username: this.asset.username, \r\n                    phone: this.asset.phone, \r\n                    deliveryaddress: this.asset.deliveryaddress,\r\n                    observation: this.asset.observation,\r\n                    clientData: this.asset.clientData,\r\n                    clientNonce: this.asset.clientNonce,\r\n                    recipientId: this.asset.recipientId,\r\n                    amount: this.asset.amount\r\n                }\r\n            }\r\n        };        \r\n\r\n        store.account.set(restaurantAccount.address, updatedRestaurantAccount);\r\n        /*\r\n        const sidechainAcc = store.account.get(this.sidechainAccountId);\r\n        const sidechainBalanceWithFee = new utils.BigNum(sidechainAcc.balance).add(new utils.BigNum(this.sidechainFee));\r\n        const updatedSidechainAccount = {\r\n            ...sidechainAcc,\r\n            balance: sidechainBalanceWithFee.toString(),\r\n            asset: {\r\n                message: \"fee\"\r\n            }\r\n        };\r\n\r\n        store.account.set(sidechainAcc.address, updatedSidechainAccount);\r\n                */\r\n        return errors;\r\n    }\r\n\r\n    /* UndoAsset function tells the blockchain how to rollback changes made in the applyAsset function.\r\n        The original balance for both the sender and restaurant account is restored.\r\n        In addition, the `asset` field for the restaurant account `null` is reseted, as it did not hold any previous data.*/\r\n    /* --- Revert sender account --- */\r\n    undoAsset(store){\r\n        const sender = store.account.get(this.senderId);\r\n\r\n        const senderBalanceWithFoodAmount = new utils.BigNum(sender.balance).add(new utils.BigNum(this.asset.amount));\r\n        const updatedSender = {\r\n            ...sender,\r\n            balance: senderBalanceWithFoodAmount.toString()\r\n        };\r\n        store.account.set(sender.address, updatedSender);\r\n\r\n        const restaurantAccount = store.account.get(this.asset.recipientId);\r\n        const restaurantBalanceWithFoodRequest = new utils.BigNum(restaurantAccount.balance).sub(new utils.BigNum(this.asset.amount).add(new utils.BigNum(this.sidechainFee)));\r\n\r\n        const updatedRestaurantAccount = {...sender, \r\n            ... { balance: restaurantBalanceWithFoodRequest.toString(),\r\n            asset: null }\r\n        };\r\n        store.account.set(restaurantAccount.address, updatedRestaurantAccount);\r\n/*\r\n        const sidechainAcc = store.account.get(this.sidechainAccount);\r\n        const sidechainBalanceWithoutFee = new utils.BigNum(sidechainAcc.balance).sub(new utils.BigNum(this.sidechainFee));\r\n\r\n        const updatedSidechainAccount = {\r\n            ...sidechainAcc,\r\n            balance: sidechainBalanceWithoutFee.toString()\r\n        };\r\n\r\n        store.account.set(sidechainAcc.address, updatedSidechainAccount);\r\n*/\r\n        return [];\r\n    }\r\n}\r\n\r\nmodule.exports = FoodTransaction;"]},"metadata":{},"sourceType":"script"}